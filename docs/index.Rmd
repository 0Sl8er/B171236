---
title: "Investigating the prescription change of Gaviscon over the winter holidays in Scotland?"
author: "Orianne Slater"
date: "`r format(Sys.time(), '%b-%Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## Introduction

Heartburn is a pain in the chest felt when acid from the stomach travels up the oesophagus. This can happen as a result of different factors including smoking, being overweight, consumption of certain food, alcohol consumption, and stress. Gaviscon can be administered to aliviate heartburn. Using data on monthly prescribed medication, this study will investigate the change in Gaviscon prescription during the winter holidays. December, with the festivities, is a month well associated with the over consumption of food and alcohol whereas January has associations of wellness and new starts. This might suggest that Gaviscon use would be higher during December compared to January.

## Loading Libraries

```{r, load-libraries, message=FALSE}
library(tidyverse)
library(janitor) #clean data
library(here) #locate data
library(gt) #tables
```


## Loading Data

Importing data files of December and January 2019-2023 downloaded from https://www.opendata.nhs.scot/dataset/prescriptions-in-the-community . These years were chosen to compare winter holidays with and without COVID lockdown restrictions (to be referenced).

```{r loading, message=FALSE, warning=FALSE}
#creating a list of the files containing prescription data
files <- list.files(here("data"), pattern = "20")

#creating a dataframe which combines all of the information in the files and cleaning the column names for consistency
all_data <- files %>% 
  map_dfr(~read_csv(here("data", .))) %>%
  clean_names()

#loading in data for healthboard names and cleaning the column names for consistency
hb <- read_csv(here("data", "health_boards.csv")) %>% 
  clean_names()

#joining precription data to healthboard names
hb_and_prescription <- all_data %>% 
  full_join(hb, by = c("hbt2014" = "hb"))
```

## Wrangling Data

```{r wrangling}
#The data must be wrangled in order to make it easier to plot later.
#filtering for data on the prescribed antibiotic we're interested in for the whole of Scotland at once
combined_scotland_data  <- hb_and_prescription %>% 
  filter(str_detect(bnf_item_description, "GAVISCON")) %>% 
  mutate(paid_date_month = parse_date_time(paid_date_month, "ym")) %>% 
  mutate(year = format(paid_date_month, "%Y"))

#creating a dataframe to add as column clarifying which holiday
years <- 2019:2022
range <- paste(years, years+1, sep = "/")
repeats <- rep(range, each = 2)
df <- tibble(holiday = repeats)

for_plot <- combined_scotland_data %>% 
  group_by(paid_date_month) %>% 
  summarise(paid_quantity = sum(paid_quantity)) %>% 
  mutate(holiday = df$holiday)
```

## Plotting Data

```{r bar-plotting}
#plotting data
combined_scotland_plot <- for_plot %>% 
  ggplot(aes(x = paid_date_month, y = paid_quantity, fill = paid_date_month))+
  geom_bar(stat = "identity")+
  labs(x = "December and January", 
       y = "Quantity of Gaviscon Prescribed", 
       title = "Trend in Gaviscon prescription over winter holidays in Scotland")
  
  #scale_fill_manual(values = rep(c("red", "green")))
combined_scotland_plot
```

## Comparison of differences between December and January

```{r table-plotting}
#making table to compare differences observed
change_in_prescription <- for_plot %>% 
  mutate(month = month(paid_date_month)) %>% 
  select(holiday, paid_quantity, month) %>% 
  pivot_wider(names_from = month, values_from = paid_quantity) %>% 
  rename(december = 2, january = 3) %>% 
  mutate(difference = december - january)

change_table <- change_in_prescription %>% 
  gt()
change_table  

#needs title, maybe highlight highest difference
```

```{r healthboard}

```

to do:
*change names
*make graph pretty (y-axis numbers, months, fill)
*change YAML theme
*make a table of Jan-Dec to oberve differences in differences (COVID?)
*use census for socioeconomics and whether that effects the proportion of change? (difference/initial)

```{r include = FALSE}
#gavison over december and january - compare the two months of different years for increase then decrease
#bar chart of each jan and dec
#table to show difference between jan and dec of each year (COVID effect)
#map or graph for the difference in each HB
#look into the effect of covid
#look into the effect of socioeconomics

#reasoning for choosing 2023 and nitrofurantoin-

#say where data is found - links specific to each dataset found at https://www.opendata.nhs.scot/dataset/prescriptions-in-the-community

#show head of dataframe?

#use list then lapply?? to filter over multiple dataframes

#or to merge do.call("rbind", list(df1, df2, df3))

#or newname<- merge(df1, df2)%>% merge(df3)

#bind_rows

#filter for nitrofurantoin

#group by healthboard and month, sum of paid quantity

#join with healthboards to know names

#lubridate for month + year

#plot x = month, y = e.g. paid quantity, coloured by healthboard

#new_date = as.character(paid_date_month)) %>% 
 # mutate(formatted_date = as.Date(new_date, format = "%Y,%m,%d")) %>% 
 # mutate(month = format(formatted_date, "%B")) %>% 
```

